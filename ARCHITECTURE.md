# CriaBot Architecture Document

## 1. Overview

CriaBot is a modular, microservice-inspired Python application designed to handle chat-based interactions, document management, and content workflows. It leverages FastAPI for HTTP APIs, Docker for containerization, and a lightweight caching and persistence layer.

Key features:
- HTTP-based API endpoints organized into controllers by domain (chats, content, docs, management)
- Central core for application setup, configuration, routing, and security
- Bot engine (`criabot`) for business logic around chat and document workflows
- Cache layer for performance optimization
- Database layer for persistent storage of bots, chats, and related entities
- Automatic API documentation via OpenAPI/Swagger

## 2. Project Layout

```
/ (project root)
├─ app/                   # FastAPI application entrypoint and HTTP controllers
│  ├─ __main__.py         # CLI entry for running the app directly
│  ├─ controllers/        # HTTP routing handlers split by domain
│  ├─ core/               # Application core modules (config, app factory, middleware)
│  └─ ...                 # Additional HTTP endpoint modules
├─ criabot/               # Core bot engine and schemas
├─ cache/                 # Caching layer interfaces and implementations
├─ database/              # Persistence layer and table definitions
├─ build.sh               # Build and local setup script
├─ Dockerfile             # Container image build definition
├─ docker-compose.yml     # Local deployment stack (app, cache, db services)
├─ entrypoint.sh          # Container entrypoint setup
├─ requirements.txt       # Python dependencies
└─ README.md              # Project overview and quickstart instructions
```

## 3. Deployment & Runtime

- **Docker & Docker-Compose**: Containerized via `Dockerfile` and orchestrated with `docker-compose.yml`. Environment configured in `docker.env`.
- **Entry Point**: `entrypoint.sh` initializes environment, applies migrations, and starts the FastAPI server.
- **Build Script**: `build.sh` automates dependency installation, linting, and image building.

## 4. HTTP Layer and Routing

1. **app/core/app.py**: Creates FastAPI instance, applies middleware, mounts Swagger UI under `/docs`.
2. **app/controllers/**: Routers by domain:
   - `/chats`: start, send, history, exists
   - `/content`: CRUD for documents and questions
   - `/manage`: bot lifecycle (create, update, delete, about)
   - `/docs`: API docs and custom assets
3. **Route Registration**: Dynamic loader in `app/core/route.py` registers routers based on conventions.

## 5. Security & API Keys

- **API Key Auth**: `app/core/security/get_api_key.py` validates each request; handlers in `app/core/security/handlers`.
- **Middleware**: `app/core/middleware.py` handles logging, CORS, and request tracing.

## 6. Bot Engine (Criabot)

- **Orchestration**: `criabot/criabot.py` manages sessions, parameters, retry logic, and error handling.
- **Schemas**: Pydantic schemas in `criabot/schemas.py` and `criabot/bot/schemas.py` for validation.
- **Chat Logic**: `criabot/bot/chat.py` and `criabot/bot/context.py` for conversation history and prompt building.
- **Buffering**: `criabot/bot/buffer.py` for streaming and batched messages.

## 7. Caching Layer

- **Cache API**: `cache/api.py` abstracts Redis or in-memory backends.
- **Core Logic**: `cache/core.py` handles TTL, key patterns, serialization.

## 8. Persistence Layer

- **Tables**: Defined in `database/bots/tables`; schemas for bots and parameters.
- **Data Access**: `database/bots/bots.py` provides high-level CRUD functions.

## 9. Documentation & OpenAPI

- **Swagger UI**: Auto-generated by FastAPI, styled via `app/controllers/docs/theme.css`.
- **Custom OpenAPI**: Overrides in `app/controllers/docs/openapi.py`.

## 10. Future Considerations

- Extend authentication (OAuth2/JWT)
- Scale with managed cache and DB services
- Integrate observability (Prometheus, OpenTelemetry)
- Add testing suite (pytest) and CI/CD (GitHub Actions)

*Generated on August 11, 2025.*
